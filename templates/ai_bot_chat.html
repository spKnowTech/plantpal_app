{% extends 'base.html' %}
{% block css %}
<style>
    .container {
        display: flex;
        height: 80vh;
        gap: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .left-panel {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }
    .right-panel {
        flex: 2;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }
    .chat-window {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 15px 15px 0 0;
    }
    .chat-input-area {
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 15px 15px;
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    .chat-input-area input {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    .chat-input-area input:focus {
        outline: none;
        border-color: #4a7c37;
    }
    .chat-input-area button {
        padding: 1rem 2rem;
        background: #4a7c37;
        color: white;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .chat-input-area button:hover {
        background: #2f5233;
    }
    .chat-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        gap: 1rem;
    }
    .chat-row.user {
        flex-direction: row-reverse;
    }
    .chat-bubble {
        max-width: 70%;
        padding: 1rem 1.5rem;
        border-radius: 20px;
        line-height: 1.5;
    }
    .user-bubble {
        background: #4a7c37;
        color: white;
        border-bottom-right-radius: 5px;
    }
    .bot-bubble {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 5px;
    }
    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    .chat-avatar i {
        color: #4a7c37;
    }
    .welcome-message {
        text-align: center;
        color: #666;
        font-style: italic;
        margin-bottom: 2rem;
    }
    .plant-info {
        background: #e8f5e8;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #4a7c37;
    }
    .plant-info h4 {
        color: #2f5233;
        margin: 0 0 0.5rem 0;
    }
    .plant-info p {
        margin: 0.25rem 0;
        color: #555;
    }
    @media (max-width: 600px) {
        .container { flex-direction: column; }
        .left-panel, .right-panel { padding: 1rem; }
        .chat-window { padding: 1rem 0.5rem; }
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}
{% block content %}
<div class="container">
    <div class="left-panel">
        <h2>ðŸŒ± Plant Assistant</h2>
        <p>Ask me anything about your plants and gardening!</p>
        
        <!-- Plant Selection Info -->
        {% if user_plants %}
            <div class="plant-info">
                <h4>Your Plants</h4>
                {% for plant in user_plants %}
                <p><strong>{{ plant.name }}</strong> - {{ plant.location }}</p>
                {% endfor %}
            </div>
        {% else %}
            <div class="welcome-message">
                <p>ðŸ‘‹ Welcome! Add some plants to your dashboard first, then come back to chat with me about them!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="right-panel">
        <div class="chat-window" id="chat-window">
            {% for message in chat_history %}
            <div class="chat-row {{ 'user' if message.is_user else 'bot' }}">
                {% if not message.is_user %}
                <span class="chat-avatar"><i class="fas fa-robot"></i></span>
                {% endif %}
                <div class="chat-bubble {{ 'user-bubble' if message.is_user else 'bot-bubble' }}">
                    {{ message.text | safe }}
                </div>
                {% if message.is_user %}
                <span class="chat-avatar"><i class="fas fa-user-circle"></i></span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <form class="chat-input-area" method="post" action="/ai_chat">
            <input type="text" name="user_message" placeholder="Type your message..." autocomplete="off" required>
            <button type="submit">Send</button>
        </form>
    </div>
</div>
<script>
    // Scroll chat to bottom on load
    const chatWindow = document.getElementById('chat-window');
    if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
</script>
{% endblock %}
{% block js %}
<script>
    const chatForm = document.getElementById('chatForm');
    const chatMessages = document.getElementById('chatMessages');

    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('userInput');
      const messageText = input.value.trim();
      if (messageText === '') return;

      // Add user message
      const userMsg = document.createElement('div');
      userMsg.classList.add('message', 'user');
      userMsg.textContent = messageText;
      chatMessages.appendChild(userMsg);

      // Simulate bot response after delay
      setTimeout(() => {
        const botMsg = document.createElement('div');
        botMsg.classList.add('message', 'bot');
        botMsg.innerHTML = '<i class="fas fa-leaf"></i><div>Thanks for your message! I will get back to you soon.</div>';
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 1000);

      input.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
</script>
{% endblock %}
